<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Постомат - Состояние ячеек</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/postomat-status.css') }}">
</head>
<body>
    <header>
        <span class="menu-icon" id="menuToggle">≡</span>
        <div class="title">Постомат - Состояние ячеек</div>
    </header>
    <div class="overlay" id="overlay"></div>
    <div class="container">
        <nav id="sidebar">
            <ul>
                <li><a href="{{ url_for('scan_documents') }}" class="{{ 'active' if current_page == 'scan-documents' else '' }}">Отсканировать документы</a></li>
                <li><a href="{{ url_for('put_documents') }}" class="{{ 'active' if current_page == 'put-documents' else '' }}">Положить документы в ячейку</a></li>
                <li><a href="{{ url_for('history') }}" class="{{ 'active' if current_page == 'history' else '' }}">История</a></li>
            </ul>
        </nav>
        <main class="status-main">
            <div class="status-layout">
                <!-- Заголовок с кнопкой -->
                <div class="status-header">
                    <h2 class="status-title">Состояние ячеек постомата</h2>
                    <button class="send-notification-btn" id="sendNotificationBtn">
                        Отправить уведомление получателю
                    </button>
                </div>

                <!-- Статистика (вверху) -->
                <div class="stats-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">{{ cells_status|selectattr('documents')|list|length }}</div>
                            <div class="stat-label">Занятых ячеек</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">{{ cells_status|selectattr('documents')|selectattr('status', 'equalto', 'Не отправлено')|list|length }}</div>
                            <div class="stat-label">Не отправлено</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">{{ cells_status|selectattr('documents')|selectattr('status', 'equalto', 'Отправлено')|list|length }}</div>
                            <div class="stat-label">Отправлено</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">{{ 24 - cells_status|selectattr('documents')|list|length }}</div>
                            <div class="stat-label">Свободных ячеек</div>
                        </div>
                    </div>
                </div>

                <!-- Таблица состояния -->
                <div class="status-table-container">
                    <table class="status-table">
                        <thead>
                            <tr>
                                <th>Ячейка</th>
                                <th>Документы</th>
                                <th>Отдел</th>
                                <th>Статус</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cell in cells_status %}
                            <tr class="{{ 'empty-cell' if not cell.documents }}">
                                <td class="cell-number">{{ cell.cell_number }}</td>
                                <td class="cell-documents">
                                    {% if cell.documents %}
                                        {{ cell.documents }}
                                    {% else %}
                                        <span class="empty-text">Пустая</span>
                                    {% endif %}
                                </td>
                                <td class="cell-department">
                                    {% if cell.department %}
                                        {{ cell.department }}
                                    {% else %}
                                        <span class="empty-text">-</span>
                                    {% endif %}
                                </td>
                                <td class="cell-status">
                                    {% if cell.status %}
                                        <span class="status-badge {{ 'sent' if cell.status == 'Отправлено' else 'not-sent' }}">
                                            {{ cell.status }}
                                        </span>
                                    {% else %}
                                        <span class="empty-text">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Уведомление -->
    <div class="notification-overlay" id="notificationOverlay" style="display: none;">
        <div class="notification-content">
            <div class="notification-icon">✓</div>
            <div class="notification-text">Уведомления отправлены получателям</div>
        </div>
    </div>

    <script>
        // Функционал выдвижного меню
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        
        menuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        });
        
        // Закрытие меню при клике на overlay
        overlay.addEventListener('click', function() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        });
        
        // Закрытие меню при клике вне его
        document.addEventListener('click', function(event) {
            const isClickInsideSidebar = sidebar.contains(event.target);
            const isClickOnToggle = menuToggle.contains(event.target);
            
            if (!isClickInsideSidebar && !isClickOnToggle && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }
        });

        // Функционал отправки уведомлений
        const sendNotificationBtn = document.getElementById('sendNotificationBtn');
        const notificationOverlay = document.getElementById('notificationOverlay');

        sendNotificationBtn.addEventListener('click', async function() {
            try {
                const response = await fetch('/send-notifications', {
                    method: 'POST'
                });
                const result = await response.json();
                console.log(result);

                // Показываем уведомление
                notificationOverlay.style.display = 'flex';

                // Анимация появления
                setTimeout(() => {
                    notificationOverlay.style.opacity = '1';
                }, 10);

                // Скрываем уведомление через 3 секунды
                setTimeout(() => {
                    notificationOverlay.style.opacity = '0';
                    setTimeout(() => {
                        notificationOverlay.style.display = 'none';
                        // Reload to update status
                        window.location.reload();
                    }, 300);
                }, 3000);
            } catch (error) {
                console.error('Error sending notifications:', error);
                alert('Error sending notifications');
            }
        });

        // Закрытие уведомления при клике на него
        notificationOverlay.addEventListener('click', function() {
            notificationOverlay.style.opacity = '0';
            setTimeout(() => {
                notificationOverlay.style.display = 'none';
            }, 300);
        });
    </script>
</body>
</html>
